#trocar o ubuntu 18.04lts na imagem base
FROM jpbp/ambientesicar:1.0 as builder

WORKDIR /app
RUN apt update && apt install nano -y
COPY backend backend

COPY frontend frontend
COPY frontend_gestao_acesso frontend_gestao_acesso
COPY car-ui-components car-ui-components
COPY site site

# build do frontend grunt --save-dev pode dar problema
#zipar as pastar node_modules e o bower component em todos os front
RUN echo '{ "allow_root": true }' > /root/.bowerrc && chown -R $(whoami) $HOME/.npm && npm install grunt -g
RUN cd site && npm install
RUN cd frontend_gestao_acesso && npm install
RUN cd frontend && npm install && bower install && grunt
#para pasta car-ui-comp (git submodule init,git submodule update)
# build do backend e grunt da bagaca
# salvar o arquivo pdf-0.9
RUN wget https://www.playframework.com/modules/pdf-0.9.zip -O /tmp/pdf-0.9.zip
RUN mkdir -p backend/modules/pdf-0.9 && cd backend && ls
RUN unzip /tmp/pdf-0.9.zip -d backend/modules/pdf-0.9
RUN echo "/opt/play-1.2.7/modules/secure" > backend/modules/secure.txt

ENV DEBIAN_FRONTEND=noninteractive
#deixar s√≥ apt 
RUN apt-get update && apt-get upgrade -y 
RUN apt install python-minimal -y 
RUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections && apt-get update && apt-get install apt-utils tzdata -y

RUN ln -sf /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
RUN dpkg-reconfigure -f noninteractive tzdata

RUN mkdir -p /arquivos/analise/
RUN mkdir -p /arquivos/demonstrativo/
RUN mkdir -p /arquivos/portal_seguranca/oficios_solicitacao/
RUN mkdir -p /arquivos/portal_seguranca/planilhas/
RUN mkdir -p /arquivos/portal_seguranca/termo_compromisso/
RUN mkdir -p /arquivos/documentos_cancelamento/
RUN mkdir -p /arquivos/imovel_car/sucesso/
RUN mkdir -p /arquivos/documentos_cancelamento/
RUN mkdir -p /arquivos/centralMensagem/anexos/
RUN mkdir -p /arquivos/integracao_sfb/shapefiles/


#ENTRYPOINT JAVA_HOME=/opt/jdk1.7.0_80 /opt/play-1.2.7/play run /app/backend

EXPOSE 9003/tcp

